name: Build and Publish NuGet Package

on:
  workflow_dispatch:
  push:
    branches: ['master']
    
permissions: 
  contents: read
  packages: write

jobs:
  build:
    runs-on: windows-2025

    env:
      BUILD_CONFIG: Release-net45
      NET_45_URL: 'https://www.nuget.org/api/v2/package/Microsoft.NETFramework.ReferenceAssemblies.net45/1.0.3'
      SDK_SYSTEM_PATH: 'C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework'

    steps:
      - name: Install .net framework 4.5 SDK
        shell: pwsh
        run: |
          echo "download ${env:NET_45_URL}"
          Invoke-WebRequest -Uri "${env:NET_45_URL}" -OutFile "${env:TEMP}\net45sdk.zip"
          echo "unzip net45sdk.zip"
          Expand-Archive -Force -LiteralPath "${env:TEMP}\net45sdk.zip" -DestinationPath "${env:TEMP}\net45sdk"
          echo "delete ${env:SDK_SYSTEM_PATH}\v4.5"
          [IO.Directory]::Delete("${env:SDK_SYSTEM_PATH}\v4.5", $True)
          echo "move SDK to ${env:SDK_SYSTEM_PATH}\v4.5"
          Move-Item -Force -LiteralPath "${env:TEMP}\net45sdk\build\.NETFramework\v4.5" -Destination "${env:SDK_SYSTEM_PATH}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Restore packages
        run: nuget restore TinCan.sln

      - name: Build
        run: msbuild TinCan.sln -p:Configuration=${env:BUILD_CONFIG}
        
      - name: Pack
        run: nuget pack .\TinCan -Properties Configuration=${env:BUILD_CONFIG}
        
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: TinCan ${{ github.run }}
          files: "*.nupkg"
        